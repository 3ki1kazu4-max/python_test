<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚²ãƒ¼ãƒ  ğŸ®</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: hidden;
    }

    #gameContainer {
      position: relative;
      border: 3px solid #fff;
      box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
    }

    #gameCanvas {
      display: block;
      background: linear-gradient(to bottom, #87CEEB 0%, #98D8C8 50%, #6B8E23 100%);
    }

    #ui {
      position: absolute;
      top: 20px;
      left: 20px;
      color: #fff;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      z-index: 10;
    }

    #healthContainer {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #healthContainer span {
      display: inline-block;
      filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.8));
    }

    #startScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      z-index: 100;
    }

    #startScreen h1 {
      font-size: 48px;
      margin-bottom: 20px;
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    #startScreen p {
      font-size: 20px;
      margin-bottom: 30px;
      color: #ccc;
    }

    #startButton {
      padding: 15px 40px;
      font-size: 24px;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      border: none;
      border-radius: 30px;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      transition: transform 0.2s;
    }

    #startButton:hover {
      transform: scale(1.1);
    }

    #gameOverScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      z-index: 100;
    }

    #gameOverScreen h2 {
      font-size: 48px;
      margin-bottom: 20px;
      color: #ff6b6b;
    }

    #finalScore {
      font-size: 32px;
      margin-bottom: 30px;
    }

    #restartButton {
      padding: 15px 40px;
      font-size: 24px;
      background: linear-gradient(45deg, #4ecdc4, #44a3a3);
      border: none;
      border-radius: 30px;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
    }

    #restartButton:hover {
      transform: scale(1.1);
    }

    #resultScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      z-index: 100;
    }

    #resultScreen h2 {
      font-size: 56px;
      margin-bottom: 30px;
      background: linear-gradient(45deg, #4ecdc4, #ffeb3b, #4ecdc4);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientMove 3s ease infinite;
      text-shadow: 0 0 30px rgba(78, 205, 196, 0.5);
    }

    @keyframes gradientMove {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    #resultStats {
      font-size: 24px;
      margin-bottom: 40px;
      text-align: center;
      line-height: 1.8;
    }

    #resultStats div {
      margin: 10px 0;
    }

    .stat-label {
      color: #ccc;
      margin-right: 10px;
    }

    .stat-value {
      color: #4ecdc4;
      font-weight: bold;
      font-size: 32px;
    }

    #resultButtons {
      display: flex;
      gap: 20px;
    }

    .result-button {
      padding: 15px 40px;
      font-size: 20px;
      background: linear-gradient(45deg, #4ecdc4, #44a3a3);
      border: none;
      border-radius: 30px;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      transition: transform 0.2s;
    }

    .result-button:hover {
      transform: scale(1.1);
    }

    .result-button.secondary {
      background: linear-gradient(45deg, #6c757d, #5a6268);
    }

    #goalDistance {
      position: absolute;
      top: 20px;
      right: 20px;
      color: #fff;
      font-size: 20px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="ui">
      <div>ã‚¹ã‚³ã‚¢: <span id="score">0</span></div>
      <div id="healthContainer">ãƒ©ã‚¤ãƒ•: <span id="health"></span></div>
    </div>
    <div id="goalDistance">ã‚´ãƒ¼ãƒ«ã¾ã§: <span id="distance">2500</span>m</div>
    <div id="startScreen">
      <h1>ğŸ® æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ğŸ®</h1>
      <p>â† â†’ ã‚­ãƒ¼ã§ç§»å‹• | ã‚¹ãƒšãƒ¼ã‚¹ã§ã‚¸ãƒ£ãƒ³ãƒ— | Zã‚­ãƒ¼ã§æ”»æ’ƒ</p>
      <p style="font-size: 16px; margin-top: 10px;">ã‚´ãƒ¼ãƒ«ã‚’ç›®æŒ‡ã›ï¼</p>
      <button id="startButton">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
    </div>
    <div id="gameOverScreen">
      <h2>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h2>
      <div id="finalScore">ã‚¹ã‚³ã‚¢: 0</div>
      <button id="restartButton">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
    </div>
    <div id="resultScreen">
      <h2>ğŸ‰ ã‚¯ãƒªã‚¢ï¼ ğŸ‰</h2>
      <div id="resultStats">
        <div>
          <span class="stat-label">ã‚¹ã‚³ã‚¢:</span>
          <span class="stat-value" id="resultScore">0</span>
        </div>
        <div>
          <span class="stat-label">ã‚¯ãƒªã‚¢æ™‚é–“:</span>
          <span class="stat-value" id="resultTime">0</span>ç§’
        </div>
        <div>
          <span class="stat-label">å€’ã—ãŸæ•µ:</span>
          <span class="stat-value" id="resultEnemies">0</span>ä½“
        </div>
      </div>
      <div id="resultButtons">
        <button class="result-button" id="playAgainButton">ã‚‚ã†ä¸€åº¦éŠã¶</button>
        <button class="result-button secondary" id="backToTitleButton">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const ui = document.getElementById('ui');
    const scoreElement = document.getElementById('score');
    const healthElement = document.getElementById('health');
    const startScreen = document.getElementById('startScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const resultScreen = document.getElementById('resultScreen');
    const startButton = document.getElementById('startButton');
    const restartButton = document.getElementById('restartButton');
    const playAgainButton = document.getElementById('playAgainButton');
    const backToTitleButton = document.getElementById('backToTitleButton');
    const distanceElement = document.getElementById('distance');

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨­å®š
    canvas.width = 1200;
    canvas.height = 600;

    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
    let gameState = 'start'; // start, playing, gameover, cleared
    let score = 0;
    let health = 100;
    let cameraX = 0;
    let particles = [];
    let powerUps = [];
    let startTime = 0;
    let gameTime = 0;
    let defeatedEnemies = 0;
    const GOAL_X = 2500; // ã‚´ãƒ¼ãƒ«ã®ä½ç½®

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
    const player = {
      x: 100,
      y: 400,
      width: 50,
      height: 80,
      speed: 5,
      jumpPower: 15,
      velocityY: 0,
      onGround: false,
      facing: 1, // 1 = right, -1 = left
      attackCooldown: 0,
      invincibleTime: 0, // ç„¡æ•µæ™‚é–“
      color: '#4ecdc4',
      trail: []
    };

    // æ•µé…åˆ—
    let enemies = [];

    // æ”»æ’ƒé…åˆ—
    let attacks = [];

    // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
    const platforms = [
      { x: 0, y: 500, width: 200, height: 20 },
      { x: 300, y: 450, width: 150, height: 20 },
      { x: 500, y: 400, width: 200, height: 20 },
      { x: 800, y: 350, width: 150, height: 20 },
      { x: 1100, y: 300, width: 200, height: 20 },
      { x: 1400, y: 400, width: 200, height: 20 },
      { x: 1700, y: 450, width: 150, height: 20 },
      { x: 2000, y: 500, width: 200, height: 20 },
      { x: 2300, y: 350, width: 150, height: 20 }, // ã‚´ãƒ¼ãƒ«ã¸ã®è¶³å ´
      { x: 2450, y: 250, width: 100, height: 20 }, // ã‚´ãƒ¼ãƒ«ã¸ã®è¶³å ´
      { x: 2470, y: 250, width: 30, height: 20 }, // ã‚´ãƒ¼ãƒ«ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
    ];

    // èƒŒæ™¯è¦ç´ 
    const backgroundElements = [];
    for (let i = 0; i < 50; i++) {
      backgroundElements.push({
        x: Math.random() * 5000,
        y: Math.random() * 400,
        size: Math.random() * 30 + 10,
        speed: Math.random() * 0.5 + 0.2,
        type: Math.random() > 0.5 ? 'cloud' : 'tree'
      });
    }

    // ã‚­ãƒ¼å…¥åŠ›
    const keys = {};
    const keyPressed = {}; // ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸç¬é–“ã‚’æ¤œå‡º

    document.addEventListener('keydown', (e) => {
      if (!keys[e.key]) {
        keyPressed[e.key] = true; // ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸç¬é–“ã‚’è¨˜éŒ²
      }
      keys[e.key] = true;
      if (e.key === ' ') e.preventDefault();
    });

    document.addEventListener('keyup', (e) => {
      keys[e.key] = false;
      keyPressed[e.key] = false;
    });

    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆ
    function createParticles(x, y, color, count = 10) {
      for (let i = 0; i < count; i++) {
        particles.push({
          x: x,
          y: y,
          vx: (Math.random() - 0.5) * 10,
          vy: (Math.random() - 0.5) * 10,
          life: 30,
          maxLife: 30,
          size: Math.random() * 5 + 2,
          color: color
        });
      }
    }

    // æ•µç”Ÿæˆï¼ˆç©ºã«æµ®ã‹ã‚“ã§ã„ã‚‹ï¼‰
    function spawnEnemy() {
      const hue = Math.random() * 60 + 300; // 300-360 (ç´«ã€œèµ¤)
      const baseY = 150 + Math.random() * 250; // ç©ºã®é«˜ã•ã«ãƒ©ãƒ³ãƒ€ãƒ é…ç½®
      enemies.push({
        x: cameraX + canvas.width + Math.random() * 200,
        y: baseY,
        baseY: baseY, // åŸºæº–Yåº§æ¨™ã‚’ä¿å­˜
        width: 40,
        height: 60,
        speed: 2 + Math.random() * 2,
        health: 2,
        color: `hsl(${hue}, 70%, 50%)`,
        jumpCooldown: 0,
        attackCooldown: 0,
        velocityY: 0,
        floatOffset: Math.random() * Math.PI * 2, // æµ®éŠã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
        floatSpeed: 0.02 + Math.random() * 0.03 // æµ®éŠã®é€Ÿåº¦
      });
    }

    // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ç”Ÿæˆ
    function spawnPowerUp() {
      powerUps.push({
        x: cameraX + canvas.width + Math.random() * 500,
        y: 300 + Math.random() * 200,
        width: 30,
        height: 30,
        type: Math.random() > 0.5 ? 'health' : 'score',
        rotation: 0,
        bobOffset: Math.random() * Math.PI * 2
      });
    }

    // è¡çªåˆ¤å®š
    function checkCollision(rect1, rect2) {
      return rect1.x < rect2.x + rect2.width &&
             rect1.x + rect1.width > rect2.x &&
             rect1.y < rect2.y + rect2.height &&
             rect1.y + rect1.height > rect2.y;
    }

    // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨ã®è¡çªåˆ¤å®š
    function checkPlatformCollision(obj) {
      for (const platform of platforms) {
        if (obj.x < platform.x + platform.width &&
            obj.x + obj.width > platform.x &&
            obj.y < platform.y + platform.height &&
            obj.y + obj.height > platform.y) {
          if (obj.velocityY > 0) { // è½ä¸‹ä¸­
            obj.y = platform.y - obj.height;
            obj.velocityY = 0;
            obj.onGround = true;
            return true;
          }
        }
      }
      return false;
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    function startGame() {
      gameState = 'playing';
      startScreen.style.display = 'none';
      gameOverScreen.style.display = 'none';
      resultScreen.style.display = 'none';
      score = 0;
      health = 100;
      cameraX = 0;
      player.x = 100;
      player.y = 400;
      player.velocityY = 0;
      player.attackCooldown = 0;
      player.invincibleTime = 0;
      enemies = [];
      attacks = [];
      particles = [];
      powerUps = [];
      startTime = Date.now();
      gameTime = 0;
      defeatedEnemies = 0;
      updateUI();
      updateDistance();
    }

    // UIæ›´æ–°
    function updateUI() {
      scoreElement.textContent = score;
      
      // ãƒ©ã‚¤ãƒ•ã‚’ãƒãƒ¼ãƒˆã§è¡¨ç¤ºï¼ˆ10ã”ã¨ã«1ãƒãƒ¼ãƒˆï¼‰
      const heartCount = Math.ceil(health / 10);
      const maxHearts = 10;
      let heartsHTML = '';
      
      for (let i = 0; i < maxHearts; i++) {
        if (i < heartCount) {
          // æº€ã‚¿ãƒ³ã®ãƒãƒ¼ãƒˆ
          heartsHTML += '<span style="color: #ff6b6b; font-size: 24px; text-shadow: 0 0 5px rgba(255, 107, 107, 0.5);">â¤</span>';
        } else {
          // ç©ºã®ãƒãƒ¼ãƒˆï¼ˆã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰
          heartsHTML += '<span style="color: #666; font-size: 24px; opacity: 0.5;">â¤</span>';
        }
      }
      
      healthElement.innerHTML = heartsHTML;
    }

    // ã‚´ãƒ¼ãƒ«è·é›¢æ›´æ–°
    function updateDistance() {
      const distance = Math.max(0, GOAL_X - player.x);
      distanceElement.textContent = distance;
    }

    // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢
    function gameClear() {
      gameState = 'cleared';
      gameTime = Math.floor((Date.now() - startTime) / 1000);
      resultScreen.style.display = 'flex';
      document.getElementById('resultScore').textContent = score;
      document.getElementById('resultTime').textContent = gameTime;
      document.getElementById('resultEnemies').textContent = defeatedEnemies;
      createParticles(GOAL_X - cameraX, 300, '#4ecdc4', 100);
    }

    // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
    function gameOver() {
      gameState = 'gameover';
      gameOverScreen.style.display = 'flex';
      document.getElementById('finalScore').textContent = `ã‚¹ã‚³ã‚¢: ${score}`;
    }

    // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
    function gameLoop() {
      if (gameState === 'playing') {
        // ã‚¯ãƒªã‚¢
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // èƒŒæ™¯æç”»
        drawBackground();

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•
        if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
          player.x -= player.speed;
          player.facing = -1;
          player.trail.push({ x: player.x, y: player.y, life: 10 });
        }
        if (keys['ArrowRight'] || keys['d'] || keys['D']) {
          player.x += player.speed;
          player.facing = 1;
          player.trail.push({ x: player.x, y: player.y, life: 10 });
        }

        // ã‚¸ãƒ£ãƒ³ãƒ—
        if ((keys[' '] || keys['ArrowUp'] || keys['w'] || keys['W']) && player.onGround) {
          player.velocityY = -player.jumpPower;
          player.onGround = false;
          createParticles(player.x + player.width / 2, player.y + player.height, '#4ecdc4', 5);
        }

        // é‡åŠ›
        player.velocityY += 0.8;
        player.y += player.velocityY;
        player.onGround = false;

        // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¡çª
        checkPlatformCollision(player);

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç”»é¢å¤–ã«è½ã¡ãŸã‚‰ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
        if (player.y > canvas.height + 100) {
          gameOver();
        }

        // æ”»æ’ƒï¼ˆã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸç¬é–“ã®ã¿ã€ä½ç½®æ›´æ–°ã®å¾Œã§å®Ÿè¡Œï¼‰
        if ((keyPressed['z'] || keyPressed['Z']) && player.attackCooldown <= 0) {
          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç¾åœ¨ä½ç½®ã‚’æ­£ç¢ºã«å–å¾—ï¼ˆãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã€ä½ç½®æ›´æ–°å¾Œï¼‰
          const attackX = player.x + (player.facing === 1 ? player.width : -30);
          const attackY = player.y + player.height / 2;
          
          attacks.push({
            x: attackX,
            y: attackY,
            width: 30,
            height: 30,
            vx: player.facing * 10,
            life: 20,
            color: '#ffeb3b'
          });
          player.attackCooldown = 15;
          createParticles(player.x + player.width / 2, player.y + player.height / 2, '#ffeb3b', 8);
        }
        // ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸç¬é–“ã®ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
        keyPressed['z'] = false;
        keyPressed['Z'] = false;

        // ã‚«ãƒ¡ãƒ©è¿½å¾“
        if (player.x > canvas.width / 2) {
          cameraX = player.x - canvas.width / 2;
        }

        // ã‚´ãƒ¼ãƒ«è·é›¢æ›´æ–°
        updateDistance();

        // ã‚´ãƒ¼ãƒ«åˆ°é”åˆ¤å®šï¼ˆã‚´ãƒ¼ãƒ«ã®ç¯„å›²å†…ã«è§¦ã‚ŒãŸã‚‰ã‚¯ãƒªã‚¢ï¼‰
        if (player.x + player.width >= GOAL_X - 30 && player.x <= GOAL_X + 70 && 
            player.y + player.height >= 250 && player.y <= 300) {
          gameClear();
        }

        // æ•µç”Ÿæˆ
        if (Math.random() < 0.01) {
          spawnEnemy();
        }

        // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ç”Ÿæˆ
        if (Math.random() < 0.003) {
          spawnPowerUp();
        }

        // æ•µæ›´æ–°ï¼ˆç©ºã‚’æµ®éŠï¼‰
        for (let i = enemies.length - 1; i >= 0; i--) {
          const enemy = enemies[i];
          enemy.x -= enemy.speed;
          
          // æ•µã®AI
          if (enemy.x < player.x + cameraX - 100) {
            enemy.x += enemy.speed * 2;
          }

          // æ•µã®æµ®éŠï¼ˆä¸Šä¸‹ã«æºã‚Œã‚‹ï¼‰
          if (enemy.floatOffset !== undefined && enemy.baseY !== undefined) {
            enemy.floatOffset += enemy.floatSpeed || 0.02;
            enemy.y = enemy.baseY + Math.sin(enemy.floatOffset) * 20; // ä¸Šä¸‹ã«20pxæºã‚Œã‚‹
          }

          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã®è¡çªï¼ˆãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã§æ¯”è¼ƒï¼‰
          if (player.invincibleTime <= 0 && checkCollision(
            { x: player.x, y: player.y, width: player.width, height: player.height },
            { x: enemy.x, y: enemy.y, width: enemy.width, height: enemy.height }
          )) {
            health -= 5;
            player.invincibleTime = 60; // 1ç§’é–“ç„¡æ•µï¼ˆ60ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰
            createParticles(player.x + player.width / 2, player.y + player.height / 2, '#ff6b6b', 15);
            if (health <= 0) {
              gameOver();
            }
            updateUI();
          }

          // ç”»é¢å¤–ã§å‰Šé™¤
          if (enemy.x < cameraX - 100) {
            enemies.splice(i, 1);
            score += 10;
            updateUI();
          }
        }

        // æ”»æ’ƒæ›´æ–°
        for (let i = attacks.length - 1; i >= 0; i--) {
          const attack = attacks[i];
          attack.x += attack.vx;
          attack.life--;

          // æ•µã¨ã®è¡çªï¼ˆãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã§æ¯”è¼ƒï¼‰
          for (let j = enemies.length - 1; j >= 0; j--) {
            const enemy = enemies[j];
            if (checkCollision(
              { x: attack.x, y: attack.y, width: attack.width, height: attack.height },
              { x: enemy.x, y: enemy.y, width: enemy.width, height: enemy.height }
            )) {
              enemy.health--;
              createParticles(enemy.x - cameraX + enemy.width / 2, enemy.y + enemy.height / 2, enemy.color, 20);
              attacks.splice(i, 1);
              if (enemy.health <= 0) {
                enemies.splice(j, 1);
                score += 50;
                defeatedEnemies++;
                createParticles(enemy.x - cameraX + enemy.width / 2, enemy.y + enemy.height / 2, '#ffeb3b', 30);
                updateUI();
              }
              break;
            }
          }

          // ç”»é¢å¤–ã§å‰Šé™¤ï¼ˆãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã§åˆ¤å®šï¼‰
          if (attack.life <= 0 || attack.x < cameraX - 50 || attack.x > cameraX + canvas.width + 50) {
            attacks.splice(i, 1);
          }
        }

        // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—æ›´æ–°
        for (let i = powerUps.length - 1; i >= 0; i--) {
          const powerUp = powerUps[i];
          powerUp.rotation += 0.1;
          powerUp.bobOffset += 0.05;

          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã®è¡çª
          if (checkCollision(
            { x: player.x, y: player.y, width: player.width, height: player.height },
            { x: powerUp.x - cameraX, y: powerUp.y + Math.sin(powerUp.bobOffset) * 10, width: powerUp.width, height: powerUp.height }
          )) {
            if (powerUp.type === 'health') {
              health = Math.min(100, health + 20);
              createParticles(powerUp.x - cameraX + powerUp.width / 2, powerUp.y + powerUp.height / 2, '#4ecdc4', 20);
            } else {
              score += 100;
              createParticles(powerUp.x - cameraX + powerUp.width / 2, powerUp.y + powerUp.height / 2, '#ffeb3b', 20);
            }
            powerUps.splice(i, 1);
            updateUI();
          }

          if (powerUp.x < cameraX - 100) {
            powerUps.splice(i, 1);
          }
        }

        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ›´æ–°
        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.x += p.vx;
          p.y += p.vy;
          p.life--;
          p.vy += 0.3; // é‡åŠ›

          if (p.life <= 0) {
            particles.splice(i, 1);
          }
        }

        // ãƒˆãƒ¬ã‚¤ãƒ«æ›´æ–°
        for (let i = player.trail.length - 1; i >= 0; i--) {
          player.trail[i].life--;
          if (player.trail[i].life <= 0) {
            player.trail.splice(i, 1);
          }
        }

        // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ›´æ–°
        if (player.attackCooldown > 0) player.attackCooldown--;
        if (player.invincibleTime > 0) player.invincibleTime--;

        // æç”»
        drawGame();
      }

      requestAnimationFrame(gameLoop);
    }

    // èƒŒæ™¯æç”»
    function drawBackground() {
      // ç©ºã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, '#87CEEB');
      gradient.addColorStop(0.5, '#98D8C8');
      gradient.addColorStop(1, '#6B8E23');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // èƒŒæ™¯è¦ç´ 
      for (const element of backgroundElements) {
        const x = element.x - cameraX * element.speed;
        if (x > -100 && x < canvas.width + 100) {
          ctx.fillStyle = element.type === 'cloud' ? 'rgba(255, 255, 255, 0.6)' : 'rgba(34, 139, 34, 0.4)';
          if (element.type === 'cloud') {
            ctx.beginPath();
            ctx.arc(x, element.y, element.size, 0, Math.PI * 2);
            ctx.fill();
          } else {
            ctx.fillRect(x, element.y, element.size, element.size * 2);
          }
        }
      }
    }

    // ã‚²ãƒ¼ãƒ æç”»
    function drawGame() {
      // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æç”»
      ctx.fillStyle = '#8B4513';
      for (const platform of platforms) {
        const x = platform.x - cameraX;
        if (x > -platform.width && x < canvas.width) {
          ctx.fillRect(x, platform.y, platform.width, platform.height);
          // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          ctx.fillStyle = '#A0522D';
          ctx.fillRect(x, platform.y, platform.width, 5);
          ctx.fillStyle = '#8B4513';
        }
      }

      // ãƒˆãƒ¬ã‚¤ãƒ«æç”»
      for (const trail of player.trail) {
        ctx.fillStyle = `rgba(78, 205, 196, ${trail.life / 10})`;
        ctx.fillRect(trail.x - cameraX, trail.y, player.width, player.height);
      }

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æç”»ï¼ˆç„¡æ•µæ™‚é–“ä¸­ã¯ç‚¹æ»…ï¼‰
      if (player.invincibleTime <= 0 || Math.floor(player.invincibleTime / 5) % 2 === 0) {
        ctx.save();
        ctx.translate(player.x - cameraX + player.width / 2, player.y + player.height / 2);
        if (player.facing === -1) {
          ctx.scale(-1, 1);
        }
        // ç„¡æ•µæ™‚é–“ä¸­ã¯è‰²ã‚’å¤‰ãˆã‚‹
        ctx.fillStyle = player.invincibleTime > 0 ? 'rgba(255, 100, 100, 0.7)' : player.color;
        ctx.fillRect(-player.width / 2, -player.height / 2, player.width, player.height);
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç›®
        ctx.fillStyle = '#fff';
        ctx.fillRect(-player.width / 2 + 10, -player.height / 2 + 15, 8, 8);
        ctx.fillRect(player.width / 2 - 18, -player.height / 2 + 15, 8, 8);
        ctx.fillStyle = '#000';
        ctx.fillRect(-player.width / 2 + 12, -player.height / 2 + 17, 4, 4);
        ctx.fillRect(player.width / 2 - 16, -player.height / 2 + 17, 4, 4);
        ctx.restore();
      }

      // æ”»æ’ƒæç”»ï¼ˆã‚«ãƒ¡ãƒ©åº§æ¨™ã‚’è€ƒæ…®ï¼‰
      for (const attack of attacks) {
        // æ”»æ’ƒã®ä½ç½®ã‚’ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™ã«å¤‰æ›
        const attackX = attack.x - cameraX;
        // ç”»é¢å†…ã®æ”»æ’ƒã®ã¿æç”»
        if (attackX > -50 && attackX < canvas.width + 50) {
          ctx.fillStyle = attack.color;
          ctx.beginPath();
          ctx.arc(attackX, attack.y, attack.width / 2, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();
        }
      }

      // æ•µæç”»ï¼ˆç©ºã‚’é£›ã‚“ã§ã„ã‚‹è¦‹ãŸç›®ï¼‰
      for (const enemy of enemies) {
        const x = enemy.x - cameraX;
        // ç”»é¢å†…ã®æ•µã®ã¿æç”»
        if (x > -enemy.width && x < canvas.width + enemy.width) {
          const wingOffset = Math.sin(Date.now() / 200 + enemy.x) * 3; // ç¿¼ã®å‹•ã
          
          // ç¿¼ï¼ˆå·¦ï¼‰
          ctx.fillStyle = enemy.color;
          ctx.beginPath();
          ctx.ellipse(x - 15, enemy.y + enemy.height / 2 + wingOffset, 20, 8, -0.3, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 2;
          ctx.stroke();
          
          // ç¿¼ï¼ˆå³ï¼‰
          ctx.beginPath();
          ctx.ellipse(x + enemy.width + 15, enemy.y + enemy.height / 2 - wingOffset, 20, 8, 0.3, 0, Math.PI * 2);
          ctx.fill();
          ctx.stroke();
          
          // æ•µã®æœ¬ä½“ï¼ˆä¸¸ã¿ã‚’å¸¯ã³ãŸå½¢ï¼‰
          ctx.fillStyle = enemy.color;
          ctx.beginPath();
          ctx.ellipse(x + enemy.width / 2, enemy.y + enemy.height / 2, enemy.width / 2, enemy.height / 2, 0, 0, Math.PI * 2);
          ctx.fill();
          
          // æ•µã®è¼ªéƒ­
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 3;
          ctx.stroke();
          
          // æ•µã®ä½“ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
          ctx.beginPath();
          ctx.ellipse(x + enemy.width / 2, enemy.y + enemy.height / 2 - 5, enemy.width / 3, enemy.height / 4, 0, 0, Math.PI * 2);
          ctx.fill();
          
          // æ•µã®ç›®ï¼ˆç™½ï¼‰
          ctx.fillStyle = '#fff';
          ctx.beginPath();
          ctx.arc(x + enemy.width / 2 - 8, enemy.y + enemy.height / 2 - 5, 6, 0, Math.PI * 2);
          ctx.fill();
          ctx.beginPath();
          ctx.arc(x + enemy.width / 2 + 8, enemy.y + enemy.height / 2 - 5, 6, 0, Math.PI * 2);
          ctx.fill();
          
          // æ•µã®ç³ï¼ˆé»’ï¼‰
          ctx.fillStyle = '#000';
          ctx.beginPath();
          ctx.arc(x + enemy.width / 2 - 8, enemy.y + enemy.height / 2 - 5, 3, 0, Math.PI * 2);
          ctx.fill();
          ctx.beginPath();
          ctx.arc(x + enemy.width / 2 + 8, enemy.y + enemy.height / 2 - 5, 3, 0, Math.PI * 2);
          ctx.fill();
          
          // æ•µã®å£
          ctx.fillStyle = '#000';
          ctx.fillRect(x + enemy.width / 2 - 8, enemy.y + enemy.height / 2 + 10, 16, 3);
          
          // é›²ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆé£›è¡Œã—ã¦ã„ã‚‹æ„Ÿã˜ï¼‰
          ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
          ctx.beginPath();
          ctx.arc(x - 10, enemy.y + enemy.height, 8, 0, Math.PI * 2);
          ctx.fill();
          ctx.beginPath();
          ctx.arc(x + enemy.width + 10, enemy.y + enemy.height, 8, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—æç”»
      for (const powerUp of powerUps) {
        const x = powerUp.x - cameraX;
        const y = powerUp.y + Math.sin(powerUp.bobOffset) * 10;
        ctx.save();
        ctx.translate(x + powerUp.width / 2, y + powerUp.height / 2);
        ctx.rotate(powerUp.rotation);
        ctx.fillStyle = powerUp.type === 'health' ? '#4ecdc4' : '#ffeb3b';
        ctx.fillRect(-powerUp.width / 2, -powerUp.height / 2, powerUp.width, powerUp.height);
        ctx.fillStyle = '#fff';
        ctx.font = '20px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(powerUp.type === 'health' ? 'â¤' : 'â­', 0, 0);
        ctx.restore();
      }

      // ã‚´ãƒ¼ãƒ«æç”»
      const goalX = GOAL_X - cameraX;
      const goalY = 270; // ã‚´ãƒ¼ãƒ«ã®Yåº§æ¨™ï¼ˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å±Šãé«˜ã•ï¼‰
      if (goalX > -100 && goalX < canvas.width + 100) {
        // ã‚´ãƒ¼ãƒ«ã®æŸ±
        ctx.fillStyle = '#FFD700';
        ctx.fillRect(goalX - 20, goalY, 40, 230);
        
        // ã‚´ãƒ¼ãƒ«ã®æ——
        ctx.fillStyle = '#FF0000';
        ctx.fillRect(goalX + 20, goalY, 60, 40);
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(goalX + 20, goalY + 40, 60, 40);
        
        // ã‚´ãƒ¼ãƒ«ã®å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        ctx.strokeStyle = 'rgba(255, 215, 0, 0.8)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(goalX, goalY, 30, 0, Math.PI * 2);
        ctx.stroke();
        
        // ã‚´ãƒ¼ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 24px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('GOAL', goalX, goalY - 20);
        
        // ã‚´ãƒ¼ãƒ«ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆè§¦ã‚Œã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
        ctx.fillStyle = '#FFD700';
        ctx.fillRect(goalX - 30, goalY - 20, 100, 10);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.strokeRect(goalX - 30, goalY - 20, 100, 10);
      }

      // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æç”»
      for (const p of particles) {
        ctx.fillStyle = `rgba(${p.color === '#4ecdc4' ? '78, 205, 196' : p.color === '#ffeb3b' ? '255, 235, 59' : '255, 107, 107'}, ${p.life / p.maxLife})`;
        ctx.beginPath();
        ctx.arc(p.x - cameraX, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    startButton.addEventListener('click', startGame);
    restartButton.addEventListener('click', () => {
      gameOverScreen.style.display = 'none';
      startGame();
    });
    playAgainButton.addEventListener('click', () => {
      resultScreen.style.display = 'none';
      startGame();
    });
    backToTitleButton.addEventListener('click', () => {
      resultScreen.style.display = 'none';
      startScreen.style.display = 'flex';
      gameState = 'start';
    });

    // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—é–‹å§‹
    gameLoop();
  </script>
</body>
</html>

